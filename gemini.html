<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>برنامه‌ریز شخصی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.0/Vazirmatn-font-face.css');
    body{font-family:'Vazirmatn',sans-serif}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 p-4">

<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl">
  <div class="flex border-b">
    <button id="add-tab-btn" class="flex-1 py-3 bg-indigo-600 text-white">افزودن</button>
    <button id="view-tab-btn" class="flex-1 py-3 bg-white text-gray-600">نمایش</button>
  </div>

  <!-- Add Tab -->
  <div id="add-tab" class="p-4 space-y-3">
    <input type="date" id="date-input" class="w-full p-2 border rounded">
    <div class="flex gap-2">
      <input type="time" id="sleep-time-input" class="flex-1 p-2 border rounded" placeholder="خواب">
      <input type="time" id="wake-up-time-input" class="flex-1 p-2 border rounded" placeholder="بیداری">
    </div>
    <div class="flex gap-2">
      <input type="number" id="tests-input" class="flex-1 p-2 border rounded" placeholder="تعداد تست">
      <input type="number" id="water-input" class="flex-1 p-2 border rounded" placeholder="آب (لیتر)">
    </div>
    <input type="text" id="food-input" class="w-full p-2 border rounded" placeholder="غذا">
    <button id="add-entry-btn" class="w-full py-2 bg-indigo-600 text-white rounded">ثبت</button>
  </div>

  <!-- View Tab -->
  <div id="view-tab" class="p-4 space-y-4 hidden">
    <div class="flex gap-2">
      <button id="chart-sleep-btn" class="px-3 py-1 bg-blue-500 text-white rounded">خواب</button>
      <button id="chart-tests-btn" class="px-3 py-1 bg-gray-200 rounded">تست</button>
      <button id="chart-water-btn" class="px-3 py-1 bg-gray-200 rounded">آب</button>
    </div>
    <div class="flex gap-2">
      <button id="period-daily-btn" class="px-3 py-1 bg-indigo-600 text-white rounded">روزانه</button>
      <button id="period-weekly-btn" class="px-3 py-1 bg-gray-200 rounded">هفتگی</button>
      <button id="period-monthly-btn" class="px-3 py-1 bg-gray-200 rounded">ماهانه</button>
    </div>
    <div class="h-72"><canvas id="chart-canvas"></canvas></div>
    <div id="avg-box" class="text-center text-gray-600"></div>
    <div>
      <h3 class="font-bold mb-2">جدول</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-100"><tr><th>تاریخ</th><th>خواب</th><th>تست</th><th>آب</th><th>غذا</th><th></th></tr></thead>
        <tbody id="data-table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="message" class="fixed top-5 right-5 bg-green-500 text-white px-3 py-2 rounded hidden"></div>

<script>
const supabase = window.supabase.createClient(
  "https://lcrnswqkscmwbrdartic.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxjcm5zd3Frc2Ntd2JyZGFydGljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Nzg2ODYsImV4cCI6MjA3MjU1NDY4Nn0.BBLDWRPayMTLCnKOpFxOFN5EpU6Hx2uK5MO5FQyTN_Y"
);

let allEntries=[],activeChart="sleep",timePeriod="daily",chartInstance=null;

// --- Utils ---
const msg=(t,e=false)=>{const m=document.getElementById("message");m.textContent=t;m.className=`fixed top-5 right-5 px-3 py-2 rounded ${e?"bg-red-500":"bg-green-500"} text-white`;m.classList.remove("hidden");setTimeout(()=>m.classList.add("hidden"),2500)};
const calcSleep=(s,w,d)=>{if(!s||!w)return 0;let[sh,sm]=s.split(":").map(Number),[wh,wm]=w.split(":").map(Number);let sd=new Date(d);sd.setHours(sh,sm);let wd=new Date(d);wd.setHours(wh,wm);if(wd<=sd)wd.setDate(wd.getDate()+1);return ((wd-sd)/36e5).toFixed(1)};

// --- Fetch & Render ---
async function fetchData(){
  let {data,error}=await supabase.from("daily_tracker_entries").select("*").order("date",{ascending:true});
  if(error){msg("خطا در دریافت",true);return}
  allEntries=data;render();
}

function aggregate(period){
  let agg={};
  allEntries.forEach(e=>{
    let d=new Date(e.date),k=e.date;
    if(period==="weekly")k=["یک","دو","سه","چهار","پنج","جمعه","شنبه"][d.getDay()];
    if(period==="monthly")k="هفته "+Math.ceil(d.getDate()/7);
    agg[k]??={sleep:[],tests:[],water:[]};
    if(e.sleep_hours!=null)agg[k].sleep.push(+e.sleep_hours);
    if(e.tests_count!=null)agg[k].tests.push(+e.tests_count);
    if(e.water_intake_liters!=null)agg[k].water.push(+e.water_intake_liters);
  });
  let labels=Object.keys(agg);
  return {
    labels,
    sleep:labels.map(k=>avg(agg[k].sleep)),
    tests:labels.map(k=>sum(agg[k].tests)),
    water:labels.map(k=>sum(agg[k].water))
  }
}
const avg=a=>a.length?(a.reduce((s,v)=>s+v,0)/a.length).toFixed(1):0;
const sum=a=>a.reduce((s,v)=>s+v,0);

function renderChart(){
  const ag=aggregate(timePeriod),map={sleep:"ساعت خواب",tests:"تعداد تست",water:"آب (لیتر)"};
  if(chartInstance)chartInstance.destroy();
  chartInstance=new Chart(document.getElementById("chart-canvas"),{
    type:"line",
    data:{labels:ag.labels,datasets:[{label:map[activeChart],data:ag[activeChart],borderColor:"rgb(99,102,241)",backgroundColor:"rgba(99,102,241,.3)",fill:true}]},
    options:{interaction:{mode:"index",intersect:false},scales:{y:{beginAtZero:true}}}
  });
  document.getElementById("avg-box").textContent=`میانگین ${map[activeChart]}: ${avg(ag[activeChart])}`;
}

function renderTable(){
  let tb=document.getElementById("data-table-body");tb.innerHTML="";
  allEntries.forEach(e=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${new Date(e.date).toLocaleDateString("fa-IR")}</td>
      <td>${e.sleep_hours||"-"}</td><td>${e.tests_count||"-"}</td>
      <td>${e.water_intake_liters||"-"}</td><td>${e.food||"-"}</td>
      <td><button onclick="del('${e.date}')" class="text-red-500">❌</button></td>`;
    tb.appendChild(tr);
  });
}

function render(){renderChart();renderTable()}

// --- Actions ---
async function addEntry(){
  let d=document.getElementById("date-input").value,
      s=document.getElementById("sleep-time-input").value,
      w=document.getElementById("wake-up-time-input").value,
      t=document.getElementById("tests-input").value,
      wa=document.getElementById("water-input").value,
      f=document.getElementById("food-input").value;
  let {data:dup}=await supabase.from("daily_tracker_entries").select("date").eq("date",d);
  if(dup.length){msg("تاریخ تکراری",true);return}
  let e={date:d,sleep_hours:calcSleep(s,w,d),sleep_time:s||null,wake_up_time:w||null,
         tests_count:t?+t:0,water_intake_liters:wa?+wa:0,food:f,timestamp:new Date().toISOString()};
  let {error}=await supabase.from("daily_tracker_entries").insert(e);if(error)msg("خطا",true);else msg("ثبت شد")
}

async function del(date){
  await supabase.from("daily_tracker_entries").delete().eq("date",date);
  msg("حذف شد")
}

// --- Events ---
document.getElementById("add-tab-btn").onclick=()=>{document.getElementById("add-tab").classList.remove("hidden");document.getElementById("view-tab").classList.add("hidden")};
document.getElementById("view-tab-btn").onclick=()=>{document.getElementById("view-tab").classList.remove("hidden");document.getElementById("add-tab").classList.add("hidden");render()};
document.getElementById("add-entry-btn").onclick=addEntry;
["sleep","tests","water"].forEach(c=>document.getElementById(`chart-${c}-btn`).onclick=()=>{activeChart=c;renderChart()});
["daily","weekly","monthly"].forEach(p=>document.getElementById(`period-${p}-btn`).onclick=()=>{timePeriod=p;renderChart()});

fetchData();
supabase.channel("changes").on("postgres_changes",{event:"*",schema:"public",table:"daily_tracker_entries"},fetchData).subscribe();
</script>
</body>
</html>
